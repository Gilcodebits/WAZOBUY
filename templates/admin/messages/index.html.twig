{% extends 'base.html.twig' %}
{% block title %}Messagerie{% endblock %}
{% block body %}
<div class="container py-4">
    <h2 class="mb-4">Messagerie</h2>
    <div class="row">
        <div class="col-md-4 border-end" style="height: 70vh; overflow-y: auto;">
            <h5>Utilisateurs</h5>
            <ul class="list-group" id="user-list">
                {% for u in utilisateurs %}
                    <li class="list-group-item user-item" data-user-id="{{ u.id }}">
                        <img src="{{ u.photoProfil ? asset(u.photoProfil) : asset('public/images/profile-placeholder.png') }}" class="rounded-circle me-2" width="32" height="32" alt="">
                        {{ u.nom }} {{ u.prenom }}
                    </li>
                {% endfor %}
            </ul>
        </div>
        <div class="col-md-8 d-flex flex-column" style="height: 70vh;">
            <div id="chat-box" class="flex-grow-1 border rounded p-3 mb-2 bg-light" style="overflow-y: auto; height: 100%;"></div>
            <form id="chat-form" class="d-flex mt-2" style="display:none;">
                <input type="text" id="chat-input" class="form-control me-2" placeholder="Ã‰crire un message..." autocomplete="off">
                <button class="btn btn-primary" type="submit">Envoyer</button>
            </form>
        </div>
    </div>
</div>
<script>
let selectedUserId = null;
const chatBox = document.getElementById('chat-box');
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');

document.querySelectorAll('.user-item').forEach(item => {
    item.addEventListener('click', function() {
        document.querySelectorAll('.user-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        selectedUserId = this.getAttribute('data-user-id');
        loadMessages();
        chatForm.style.display = '';
    });
});

function loadMessages() {
    chatBox.innerHTML = '<div class="text-center text-muted">Chargement...</div>';
    fetch(`{{ path('admin_chat_messages') }}?user_id=${selectedUserId}`)
        .then(r => r.json())
        .then(data => {
            chatBox.innerHTML = '';
            data.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'mb-2 ' + (msg.isMe ? 'text-end' : 'text-start');
                div.innerHTML = `<span class="badge bg-${msg.isMe ? 'primary' : 'secondary'}">${msg.isMe ? 'Moi' : 'Lui'}</span> <span class="small text-muted">${msg.date}</span><br><span class="p-2 d-inline-block rounded" style="background:${msg.isMe ? '#e3f0ff' : '#f8f9fa'};max-width:70%">${msg.content}</span>`;
                chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        });
}

chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    if (!chatInput.value.trim()) return;
    const formData = new FormData();
    formData.append('user_id', selectedUserId);
    formData.append('content', chatInput.value);
    fetch(`{{ path('admin_chat_send') }}`, {
        method: 'POST',
        body: formData
    }).then(r => r.json()).then(data => {
        if (data.success) {
            chatInput.value = '';
            loadMessages();
        }
    });
});
</script>
<style>
.user-item.active { background: #e3f0ff; font-weight: bold; }
#chat-box { min-height: 300px; }
</style>
{% endblock %} 